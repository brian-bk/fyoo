version: "3"
services:
  mysql:
    image: mysql
    environment: { MYSQL_ROOT_PASSWORD: fyoopw1! }
  postgres:
    image: postgres
    environment: { POSTGRES_PASSWORD: fyoopw1! }
  tests:
    image: circleci/python$PYTHON_IMAGE_TAG
    environment:
      CODECOV_TOKEN: $CODECOV_TOKEN
    command:
      - bash
      - -c
      - |
        set -euxp pipefail
        WORKDIR="$$(mktemp -d -t integration.XXXX)"
        cp -R /home/circleci/project "$$WORKDIR"
        cd "$$WORKDIR"/project

        ./tests/wait-for-it.sh -t 60 mysql:3306
        ./tests/wait-for-it.sh -t 60 postgres:5432

        # Wait 1 extra second - make sure dbs can actually receive
        # connections
        sleep 1

        virtualenv -p python3 venv
        ./venv/bin/pip install -e .[all]
        set +x
        . ./venv/bin/activate
        set -x

        coverage run -m pytest tests/integration
        coverage html

        if [ ! -z "$${CODECOV_TOKEN}" ]; then
          codecov
        fi
    volumes:
      - ../../:/home/circleci/project
    depends_on:
      - mysql
      - postgres
    links:
      - mysql
      - postgres
