version: "3"
services:
  mysql:
    environment:
      MYSQL_ROOT_PASSWORD: fyoopw
    image: mysql
  postgres:
    environment:
      POSTGRES_PASSWORD: fyoopw
    image: postgres
  tests:
    build:
      context: ../../
      dockerfile: tests/integration/Dockerfile
      args:
        version: $CIRCLECI_PYTHON_VERSION
    environment:
      CODECOV_TOKEN: $CODECOV_TOKEN
    command:
      - bash
      - -c
      - |
        set -euxp pipefail

        ./tests/wait-for-it.sh -t 60 mysql:3306
        ./tests/wait-for-it.sh -t 60 postgres:5432

        # Wait 1 extra second - make sure dbs can actually receive
        # connections
        sleep 1

        VENV="$$(mktemp -d -t venv-all.XXXX)"
        virtualenv -p python3 "$$VENV"
        "$$VENV"/bin/pip install .[all]
        set +x
        . "$$VENV"/bin/activate
        set -x

        coverage run -m pytest tests/integration
        coverage html

        if [ ! -z "$${CODECOV_TOKEN}" ]; then
          codecov
        fi
    depends_on:
      - mysql
      - postgres
    links:
      - mysql
      - postgres
